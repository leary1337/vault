---
создал заметку: 2024-07-30
tags:
  - golang
---
### Описание

**Структура (struct)** в Go — это пользовательский тип данных, объединяющий значения различных типов в один объект. Структура описывается набором полей, каждое из которых имеет свое имя и тип. Размер памяти пустой структуры составляет 0 байт.

```go
type Person struct {
    Name string
    Age  int
}

func main() {
	p := Person{"Alice", 30} // {Alice 30}  
	p := Person{Name: "Alice", Age: 30} // {Alice 30}  
	p := Person{Name: "Alice"} // {Alice 0}  
	  
	p := new(Person) // &{"" 0}  
	p := &Person{} // &{"" 0}  
	  
	var p Person // {"" 0}
}
```

Если переменная типа структуры не была явно инициализирована, она по умолчанию получает *zero value*.
#### Инкапсуляция в Go

Инкапсуляция в Go достигается через механизм видимости полей и методов. Поля и методы, начинающиеся с заглавной буквы, являются экспортируемыми и доступны из других пакетов. Поля и методы, начинающиеся со строчной буквы, не экспортируются и доступны только внутри того же пакета.

Пример инкапсуляции:
```go
type Person struct {
    Name string
    age  int // неэкспортируемое поле
}

func (p *Person) SetAge(age int) {
    p.age = age
}

func (p *Person) GetAge() int {
    return p.age
}
```
#### Value и Pointer Receivers

В Go методы могут принимать структуру как **value receiver** или **pointer receiver**:

**Value Receiver**:

- Метод получает копию структуры. Изменения в методе **не затрагивают** оригинальную структуру.
- Подходит для методов, которые не изменяют структуру или когда структура небольшого размера.

```go
func (p Person) Greet() string {
    return "Hello, " + p.Name
}
```

**Pointer Receiver**:

- Метод получает указатель на структуру, что позволяет **изменять** её состояние.
- Рекомендуется для методов, изменяющих структуру, и для структур большого размера, чтобы избежать копирования данных.

```go
func (p *Person) Rename(newName string) {
    p.Name = newName
}
```

#### Встраивание (Embedding) и отличие от наследования

**Встраивание (embedding)** в Go — это механизм, который позволяет одной структуре включать другую структуру или интерфейс в качестве анонимного поля. Это отличается от традиционного наследования в том, что Go не поддерживает наследование, как в объектно-ориентированных языках, таких как Java или C++. В Go отсутствуют классы и механизм наследования, а композиция и встраивание служат для достижения похожих целей.

Пример встраивания:
```go
type Animal struct {
    Name string
}

type Dog struct {
    Animal // Встраивание структуры Animal
    Breed  string
}
```

В этом примере `Dog` включает в себя `Animal`, и при этом можно обращаться к полям `Animal` напрямую через `Dog`, например:
```go
d := Dog{
    Animal: Animal{Name: "Buddy"},
    Breed:  "Golden Retriever",
}
fmt.Println(d.Name) // Вывод: Buddy
```
#### Передача в функции

Структуры могут передаваться в функции по значению или по указателю.

**Передача по значению**:

- Создается копия структуры. Изменения внутри функции **не затрагивают** оригинальную структуру.
- Может привести к ошибкам, если предполагается, что изменения должны быть видны за пределами функции.

```go
func UpdateName(p Person, newName string) {
    p.Name = newName
}

p := Person{Name: "Alice"}
UpdateName(p, "Bob")
fmt.Println(p.Name) // Вывод: Alice
```

**Передача по указателю**:

- Функция получает указатель на оригинальную структуру, что позволяет изменять её состояние.
- Рекомендуется использовать для больших структур или если нужно изменять данные.

```go
func UpdateName(p *Person, newName string) {
    p.Name = newName
}

p := Person{Name: "Alice"}
UpdateName(&p, "Bob")
fmt.Println(p.Name) // Вывод: Bob
```
#### Внутреннее устройство

Под капотом, структура в Go является последовательностью данных в памяти, где каждое поле имеет свое смещение (`offset`). Поля структуры *выравниваются в памяти* в зависимости от их типов, что помогает оптимизировать доступ к данным и минимизировать неиспользуемое пространство (paddings).
#### Выравнивание типов (type alignment)

**Выравнивание типов** — это процесс размещения данных в памяти таким образом, чтобы каждый элемент данных находился на "естественной границе" (alignment boundary). В контексте структур в Go, выравнивание гарантирует, что поля структур располагаются на адресах, кратных их размеру, что оптимизирует доступ к данным.

**Адрес 2-байтового типа(_int16_) должен быть кратен 2, адрес 4-байтового значения(_int32_) должен быть кратен 4, а 8-байтового соответственно кратен 8.**

**Почему важно выравнивание?**

1. **Производительность**: Современные процессоры лучше работают с данными, выровненными по определенным границам. Невыравненные данные могут потребовать дополнительных операций чтения/записи, что замедляет доступ к памяти.
2. **Корректность работы**: Некоторые процессоры могут не поддерживать невыравненные операции доступа к памяти, что может привести к аварийным завершениям программ.

**Выравнивание полей структур:**

Компилятор Go добавляет паддинги (*padding*) для выравнивания данных. Паддинг — это дополнительные байты, которые вставляются в структуру для того, чтобы поля данных начинались с выровненных адресов памяти, что важно для производительности процессора.

**Оптимизация паддингов:**

![](https://i.imgur.com/fOOK5M5.gif)

*Порядок полей имеет значение, благодаря нему можно сократить размер структуры в памяти*

```go
type StructA struct { // 32 bytes
  A byte
  B int32
  C byte
  D int64
  E byte
}

type StructB struct { // 16 bytes
  B int32
  A byte
  C byte
  E byte
  D int64
}
```
### Краткое содержание

**Структура (struct)** в Go — это пользовательский тип данных, объединяющий значения различных типов в один объект. Структура описывается набором полей, каждое из которых имеет свое имя и тип. Размер памяти пустой структуры составляет 0 байт. ^sum-struct
