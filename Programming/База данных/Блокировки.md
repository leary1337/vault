---
создал заметку: 2024-08-11 10:32
tags:
  - db
  - base
---
### Описание

**Блокировки** — это механизм управления доступом к данным, который используется для предотвращения конфликтов при одновременном доступе к одному и тому же набору данных несколькими транзакциями. Это необходимо для обеспечения целостности данных и согласованности транзакций.

Блокировки нужны для обеспечения следующих аспектов:

- **Целостность данных:** Без блокировок данные могут быть повреждены из-за одновременного изменения несколькими транзакциями.
- **Согласованность транзакций:** Блокировки помогают соблюдать ACID свойства транзакций.
- **Предотвращение гонок:** Без блокировок могут возникнуть ситуации, когда две транзакции одновременно читают и записывают данные, что может привести к некорректным результатам.
#### **Типы блокировок**

Существует несколько типов блокировок, которые обеспечивают различный уровень доступа к данным:

- **Блокировка на чтение (Shared Lock, S или Блокировка разделяемого доступа):**
    - Позволяет другим транзакциям читать данные, но не изменять их.
    - Используется при выполнении операций `SELECT`.
    
- **Блокировка на запись (Exclusive Lock, X или Блокировка эксклюзивного доступа):**
    - Полностью блокирует доступ к данным для других транзакций: ни читать, ни изменять.
    - Используется при выполнении операций `UPDATE`, `DELETE`, `INSERT`.
    
- **Блокировка намерения (Intention Lock):**
    - Это разновидность блокировок, которая указывает на намерение транзакции взять более жесткую блокировку (например, эксклюзивную). Существуют различные подтипы, такие как Intent Shared (IS), Intent Exclusive (IX), и так далее.
    
- **Блокировка обновления (Update Lock, U):**
    - Гибридная блокировка, используемая для предотвращения взаимных блокировок (deadlock). Сначала данные блокируются на чтение, а затем на запись.
#### SELECT FOR UPDATE

`SELECT FOR UPDATE` — это конструкция SQL, которая выполняет запрос на чтение данных с наложением блокировки записи (*exclusive lock*) на выбранные строки. Эта блокировка удерживается до окончания транзакции. `SELECT FOR UPDATE` используется, когда нужно прочитать данные с намерением их изменить, чтобы другие транзакции не могли изменять эти данные до завершения текущей транзакции.

```sql
BEGIN TRANSACTION;

SELECT * FROM accounts WHERE account_id = 12345 FOR UPDATE;

-- Здесь может выполняться какая-то логика обработки данных

UPDATE accounts SET balance = balance - 100 WHERE account_id = 12345;

COMMIT;

```
В этом примере, до выполнения `UPDATE`, строка с `account_id = 12345` будет заблокирована для других транзакций на запись.
#### **Проблемы, связанные с блокировками**

Несмотря на полезность, блокировки могут вызывать проблемы:

- **Взаимные блокировки (Deadlock):** Возникают, когда две транзакции ждут друг друга для освобождения ресурсов.
- **Удлинение времени выполнения транзакций:** Блокировки могут замедлить выполнение транзакций, особенно если они удерживаются слишком долго.
- **Истощение ресурсов:** Большое количество блокировок может привести к повышенному расходу памяти и снижению производительности.
#### **Механизмы управления блокировками**

Базы данных используют различные стратегии для управления блокировками и разрешения конфликтов:

- **Автоматическое обнаружение и устранение взаимных блокировок.**
- **Изоляционные уровни транзакций:** Позволяют выбирать степень блокировок (например, Serializable, Repeatable Read, Read Committed, Read Uncommitted).
- **Оптимистические и пессимистические блокировки:** Оптимистический подход предполагает, что конфликты маловероятны, и транзакции могут обрабатывать данные без блокировок до проверки. Пессимистический подход предполагает использование блокировок для предотвращения конфликтов.
### Краткое содержание

**Блокировки** — это механизм управления доступом к данным, который используется для предотвращения конфликтов при одновременном доступе к одному и тому же набору данных несколькими транзакциями. Это необходимо для обеспечения целостности данных и согласованности транзакций. ^sum-db-locks
